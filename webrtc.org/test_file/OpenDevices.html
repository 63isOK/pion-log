<html>

<head>
  <title>我的第一个 HTML 页面</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body>
  <p>body 元素的内容会显示在浏览器中。</p>
  <p>title 元素的内容会显示在浏览器的标题栏中。</p>
  <select id="availableCameras">
  </select>
</body>

<script>

  // query devices
  async function queryDevices(type) {
    const devices = await navigator.mediaDevices.enumerateDevices();
    return devices.filter(device => device.kind === type)
  }

  console.log('cameras found:', queryDevices('videoinput'))
  console.log('mic found:', queryDevices('audioinput'))

  // NOTE: promise写法
  // navigator.mediaDevices.enumerateDevices()
  //   .then(function (devices) {
  //     devices.forEach(function (device) {
  //       console.log(device.kind + ":" + device.label + " id=" + device.deviceId);
  //     });
  //   })
  //   .catch(function (err) {
  //     console.log(err.name + ":" + err.message);
  //   });

  // device change event

  function updateCameraList(cameras) {
    const listElement = document.querySelector('select#availableCameras');
    listElement.innerHTML = '';
    cameras.map(camera => {
      const cameraOption = document.createElement('option');
      cameraOption.label = camera.label;
      cameraOption.value = camera.deviceId;
    }).forEach(cameraOption => listElement.add(cameraOption));
  }

  const cameras = queryDevices('videoinput');
  updateCameraList(cameras);

  navigator.mediaDevices.addEventListener('devicechange', event => {
    const newList = queryDevices('videoinput');
    updateCameraList(newList);
  })

  // open divices

  const openDevices = async (constraints) => {
    return await navigator.mediaDevices.getUserMedia(constraints);
  }

  try {

    const stream = openDevices({
      'video': true,
      'audio': true
    });

    console.log('got MediaStream', stream);

  } catch (error) {

    console.error('error accessing media devices.', error);
  }
</script>

</html>